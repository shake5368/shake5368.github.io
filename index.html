<!DOCTYPE html>
<html>
<head>
<title>即時語音問答與建議</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
#transcript {
height: 300px; /* 調整高度 */
overflow-y: scroll;
}
#suggestions {
height: 300px; /* 調整高度 */
overflow-y: scroll;
}
.message { margin-bottom: 15px; }
.message.user { text-align: right; }
.message.bot { text-align: left; }
.message-content {
display: inline-block;
padding: 10px 15px;
border-radius: 8px;
max-width: 70%;
}
.message.user .message-content { background-color: #DCF8C6; }
.message.bot .message-content { background-color: #FF9797; }
.recording-indicator {
width: 10px;
height: 10px;
background-color: red;
border-radius: 50%;
display: inline-block;
margin-left: 5px;
animation: blink 1s infinite;
}
@keyframes blink {
50% {
background-color: transparent;
}
}
</style>
</head>
<body>
<div class="container mt-5">
<div class="row">
<div class="col-md-6">
<h4>問答視窗</h4>
<button id="startButton" class="btn btn-primary">開始對話</button>
<button id="stopButton" class="btn btn-danger" disabled>結束對話</button>
<span id="recordingIndicator" class="recording-indicator" style="display:none;"></span>
<div id="transcript" class="mt-3 border rounded p-3">
</div>
</div>
<div class="col-md-6">
<h4>建議項目</h4>
<div id="suggestions" class="mt-3 border rounded p-3"></div>
</div>
</div>
</div>

<script>
const startButton = document.getElementById('startButton');
const stopButton = document.getElementById('stopButton');
const transcript = document.getElementById('transcript');
const suggestionsZone = document.getElementById('suggestions');
const recordingIndicator = document.getElementById('recordingIndicator');
const audioMap = new Map();
let mediaRecorder;
let isRecording = false;
startButton.addEventListener('click', async () => {
audioMap.clear();
transcript.textContent = ''; // 清空之前的紀錄
suggestionsZone.innerHTML = ''; // 清空之前的建議
const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
mediaRecorder = new MediaRecorder(stream);
startRecording();
startButton.disabled = true;
stopButton.disabled = false;
});

stopButton.addEventListener('click', () => {
stopRecording();
startButton.disabled = false;
stopButton.disabled = true;
});
function startRecording() {
isRecording = true;
recordingIndicator.style.display = 'inline-block';
const chunks = [];
mediaRecorder.ondataavailable = e => chunks.push(e.data);
mediaRecorder.onstop = async () => {
recordingIndicator.style.display = 'none';
const blob = new Blob(chunks, { type: 'audio/webm; codecs=opus' });
const reader = new FileReader();
reader.onloadend = async () => {
if (isRecording) {
const base64Audio = reader.result;
// const result = await processAudio(blob);
// 使用範例 (假設 audioBlob 已取得)
// transcribeAudio(blob)
// .then(transcript => {
const myUUID = crypto.randomUUID();
audioMap.set(myUUID, base64Audio);
appendMessage('user', '天氣', myUUID);
// bot回覆
const botTranscript = generateBotResponse('天氣');
if(botTranscript.length == 0)
{
botTranscript.push("請提供更具體的資訊，我將盡力為您解答。");
}

const voiceBlob = speakToVoice(botTranscript, myUUID);

  console.log(voiceBlob);
  
// 產生建議
const generatedSuggestions = generateSuggestions('天氣');
updateSuggestions(generatedSuggestions);
// })
// .catch(error => {
// console.error(error);
// });
startRecording();
}
};
reader.readAsDataURL(blob);
};
mediaRecorder.start();
setTimeout(() => mediaRecorder.stop(), 4000);
}
function stopRecording() {
isRecording = false;
mediaRecorder.stop();
}
async function processAudio(audioBlob) {
return new Promise(resolve => {
const formData = new FormData();
const myUUID = crypto.randomUUID();
formData.append('audio', audioBlob, 'recording.webm'); // 假設音訊格式為 WebM
formData.append('uuid', myUUID);
try {
const result = fetch('/upload', {
method: 'POST',
body: formData
})
.then(response => {
if (!response.ok) {
throw new Error(`HTTP error! Status: ${response.status}`);
}
return response.json(); // 解析 JSON 資料
})
.then(data => {
// 處理成功取得的 JSON 資料
return data;
})
;
resolve(result);
} catch (error) {
console.error('轉錄錯誤:', error);
throw error; // 將錯誤傳遞給呼叫者處理
}
});
}

function appendMessage(sender, content, uuid) {
const messageElement = document.createElement('div');
messageElement.classList.add('message', sender);
messageElement.innerHTML = `<div class="message-content">${content}</div>`;
const audioBlob = audioMap.get(uuid);
const audio = document.createElement('audio');
audio.style.display = 'none';
audio.src = audioBlob;
messageElement.appendChild(audio);
messageElement.addEventListener('click', function() {
const audioElement = messageElement.querySelector('audio');
audioElement.play();
});
transcript.appendChild(messageElement);
// 自動滾動到底部
transcript.scrollTop = transcript.scrollHeight;
}
function generateBotResponse(text) {
const keywords = text.toLowerCase().replace(/\s+/g, '');
const possibleBotResponse = [
{ keyword: '天氣', bot: '下雨機率50%' },
{ keyword: '新聞', bot: '控以軍空襲拉法！ 哈瑪斯衛生部：至少35死、數十人受傷： 以色列對加薩最南端拉法巿一個流離失所者收容中心展開空襲，造成至少35人喪生、數十人受傷。伊朗總統直升機驚傳墜毀！ 最高領袖喊話人民：無需為國家擔心： 搭載伊朗總統萊希的直升機驚傳意外後，伊朗最高領袖哈米尼敦促民眾「無需為國家擔心」。' },
{ keyword: '投資', bot: '作為一個AI，我無法提供個人化的投資建議' },
];

return possibleBotResponse.filter(item => keywords.includes(item.keyword))
.flatMap(item => item.bot);
}
function generateSuggestions(text) {
// 在這裡根據 text 內容實作產生建議的邏輯
// 這是一個範例，您需要根據實際需求修改
const keywords = text.toLowerCase().replace(/\s+/g, '');
const possibleSuggestions = [
{ keyword: '天氣', suggestions: ['建議外出攜帶雨傘'] },
{ keyword: '新聞', suggestions: ['您可以點擊以下連結，了解更多詳細報導：中央社CNA： https://www.cna.com.tw/list/headlines.aspx'] },
// ... (更多關鍵字與建議)
];

return possibleSuggestions.filter(item => keywords.includes(item.keyword))
.flatMap(item => item.suggestions);
}

function updateSuggestions(suggestions) {
suggestionsZone.innerHTML = ''; // 清空之前的建議
suggestions.forEach(suggestion => {
const listItem = document.createElement('li');
listItem.textContent = suggestion;
suggestionsZone.appendChild(listItem);
});
}
async function transcribeAudio(audioBlob) {
const requestBody = {
config: {
encoding: 'WEBM_OPUS',
sampleRateHertz: 48000, // 請根據您的實際取樣率調整
languageCode: 'zh-TW' // 設定語言 (可選)
},
audio: {
content: await blobToBase64(audioBlob)
}
};
try {
const response = await fetch(
`https://speech.googleapis.com/v1/speech:recognize?key=AIzaSyBJA3i5Lmsh44FPY0GBsAaUVxhNjqD5Gdo`,
{
method: 'POST',
body: JSON.stringify(requestBody),
headers: {
'Content-Type': 'application/json'
}
}
);
if (!response.ok) {
throw new Error(`Google Speech-to-Text API error: ${response.status}`);
}
const data = await response.json();
if (data.results && data.results.length > 0) {
return data.results[0].alternatives[0].transcript;
} else {
throw new Error('No transcript found');
}
} catch (error) {
console.error('Transcription error:', error);
throw error;
}
}
async function speakToVoice(text, uuid) {
const utterance = new SpeechSynthesisUtterance(text);
utterance.lang = 'zh-TW'; // 設定語言為繁體中文 (可依需求調整)

// 使用 onvoiceschanged 事件確保語音列表已加載
await new Promise(resolve => {
if (speechSynthesis.onvoiceschanged !== undefined) {
resolve();
} else {
speechSynthesis.onvoiceschanged = resolve;
}
});
// 选择您想要的语音 (例如 Google 國語（臺灣）)
const desiredVoice = speechSynthesis.getVoices().find(voice => voice.name === 'Google 國語（臺灣）');
if (desiredVoice) {
utterance.voice = desiredVoice;
}
let audioBase64;

// 將語音合成結果儲存為 Base64
speechSynthesis.addEventListener('voiceschanged', () => {
speechSynthesis.speak(utterance);
});
utterance.onboundary = (event) => {
if (event.name === 'mark') {
audioBase64 = event.utterance.output[event.charIndex].split(',')[1]; // 取得 Base64 部分
}
};
// 等待語音合成完成
await new Promise(resolve => {
  utterance.onend = (event) => {
    console.log(audioBase64);
    resolve(audioBase64);
  };
});
}
// 將 Blob 轉換為 Base64 字串
function blobToBase64(blob) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onloadend = () => resolve(reader.result.split(',')[1]); // 去除 Data URL 前綴
reader.onerror = reject;
reader.readAsDataURL(blob);
});
}
</script>
</body>
</html>
